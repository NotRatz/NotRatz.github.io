  <script>
    // Always show admin top-bar with tournament management
    function getAdminTournaments() {
      try {
        return JSON.parse(localStorage.getItem('adminTournaments') || '[]');
      } catch { return []; }
    }
    function saveAdminTournament(t) {
      const arr = getAdminTournaments();
      arr.push(t);
      localStorage.setItem('adminTournaments', JSON.stringify(arr));
    }
    function createNewTournament() {
      const name = prompt('Tournament name:');
      if (!name) return;
      const id = 't_' + Math.random().toString(36).slice(2, 10);
      saveAdminTournament({ id, name });
      window.location.href = window.location.pathname + '?admin=1&tournament=' + id;
    }
    function getPanelLinks(id) {
      const base = window.location.origin + window.location.pathname.replace(/\/index\.html$/, '/');
      return {
        admin: base + '?admin=1&tournament=' + id,
        player: base + '?player=1&tournament=' + id,
        spectator: base + '?spectator=1&tournament=' + id
      };
    }
    document.addEventListener('DOMContentLoaded', function() {
      const tournaments = getAdminTournaments();
      const bar = document.createElement('div');
      bar.className = 'w-full bg-yellow-500 text-gray-900 font-bold px-4 py-2 flex items-center justify-between shadow fixed top-0 left-0 z-50';
      let tournamentLinks = '';
      if (tournaments.length === 0) {
        tournamentLinks = '<span class="italic text-gray-700">No tournaments yet</span>';
      } else {
        tournamentLinks = tournaments.map(t => {
          const links = getPanelLinks(t.id);
          return `<span class="px-2"><a href="${links.admin}" class="underline">${t.name}</a></span>`;
        }).join('');
      }
      bar.innerHTML = `
        <span class="flex items-center gap-2">
          <button onclick="createNewTournament()" title="Create New Tournament" class="bg-gray-900 text-yellow-500 rounded-full w-7 h-7 flex items-center justify-center text-xl font-bold mr-2 hover:bg-gray-800">+</button>
          Admin Tournaments
        </span>
        <div class="flex items-center gap-2">${tournamentLinks}</div>
      `;
      document.body.prepend(bar);
      document.body.style.paddingTop = '56px';
    });
  </script>
<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="shortcut icon" href="../favicon.png" />
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strive Scoring Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body {
      background: url('../assets/naraka-bg.png') center/cover no-repeat fixed;
      background-color: rgba(0, 0, 0, 0.85);
      background-blend-mode: overlay;
    }
    .score-table th, .score-table td {
      border: 1px solid #333;
      padding: 0.5rem;
    }
    .team-box {
      background-color: #1a1a1a;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-4 text-yellow-500 drop-shadow">Strive Naraka Scoring Tool</h1>
  <div class="mb-6 bg-black/60 rounded-xl p-4 border border-yellow-500 max-w-xl mx-auto">
    <h2 class="text-xl font-semibold text-yellow-400 mb-2">Scoring Template</h2>
    <table class="w-full text-sm text-gray-200 mb-2">
      <thead>
        <tr class="border-b border-yellow-500">
          <th class="py-1">Rank</th>
          <th class="py-1">Kill Multiplier</th>
          <th class="py-1">Placement Points</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>1st</td><td>1.2x</td><td>3</td></tr>
        <tr><td>2nd</td><td>1.0x</td><td>2</td></tr>
        <tr><td>3rd</td><td>0.8x</td><td>1</td></tr>
        <tr><td>4th-12th</td><td>0.6x</td><td>0</td></tr>
      </tbody>
    </table>
    <p class="text-xs text-gray-400">Scoring is fixed. Upload CSVs and view results below.</p>
  </div>

  <div class="mb-6">
  <label class="block mb-2 text-yellow-400">Upload up to 6 CSV files (each one match):</label>
  <input type="file" id="csvFiles" accept=".csv" multiple class="mb-4">
  <button onclick="processFiles()" class="bg-yellow-500 text-gray-900 px-4 py-2 rounded font-semibold hover:bg-yellow-400 transition-colors">Generate Scoreboard</button>
  <button onclick="exportPNG()" class="bg-green-500 text-gray-900 px-4 py-2 rounded ml-2 font-semibold hover:bg-green-400 transition-colors">Export as PNG</button>
  </div>

  <div id="scoreboard" class="overflow-x-auto mt-6"></div>

  <script>
    function processFiles() {
      const files = document.getElementById('csvFiles').files;
      if (!files.length) return;
      let allData = [];
      let filesProcessed = 0;
      for (let file of files) {
        Papa.parse(file, {
          header: true,
          complete: function(results) {
            allData.push(results.data);
            filesProcessed++;
            if (filesProcessed === files.length) {
              calculateScores(allData.flat());
            }
          }
        });
      }
    }

    // Hardcoded scoring template
    const SCORING_TEMPLATE = [
      { rank: 1, killMultiplier: 1.2, placement: 3 },
      { rank: 2, killMultiplier: 1.0, placement: 2 },
      { rank: 3, killMultiplier: 0.8, placement: 1 },
      // 4th-12th
    ];

    function getScoringForRank(rank) {
      if (rank === 1) return SCORING_TEMPLATE[0];
      if (rank === 2) return SCORING_TEMPLATE[1];
      if (rank === 3) return SCORING_TEMPLATE[2];
      return { killMultiplier: 0.6, placement: 0 };
    }

    function calculateScores(data) {
      const teams = {};
      data.forEach(row => {
        const teamID = row.TeamID;
        const playerName = row.PlayerName;
        const rank = parseInt(row.Rank);
        const kills = parseInt(row.KillCount);
        const damage = parseInt(row.TotalHurt);
        if (!teams[teamID]) {
          teams[teamID] = {
            teamID,
            players: [],
            totalKills: 0,
            totalDamage: 0,
            score: 0,
            rank: rank
          };
        }
        teams[teamID].players.push({ name: playerName, kills, damage });
        teams[teamID].totalKills += kills;
        teams[teamID].totalDamage += damage;
        // Use hardcoded scoring template
        const scoring = getScoringForRank(rank);
        teams[teamID].score += kills * scoring.killMultiplier;
        teams[teamID].score += scoring.placement / 3; // split evenly (3p teams)
      });
      const sortedTeams = Object.values(teams).sort((a, b) => b.score - a.score);
      const container = document.getElementById('scoreboard');
      container.innerHTML = `
        <table class="score-table w-full text-left">
          <thead>
            <tr class="bg-yellow-900">
              <th class="text-yellow-400">Rank</th>
              <th class="text-yellow-400">Players</th>
              <th class="text-yellow-400">Total Kills</th>
              <th class="text-yellow-400">Total Damage</th>
              <th class="text-yellow-400">Points</th>
            </tr>
          </thead>
          <tbody>
            ${sortedTeams.map((team, i) => `
              <tr class="bg-black/60">
                <td class="font-bold text-yellow-300">${i + 1}</td>
                <td>
                  <div class="team-box">
                    ${team.players.map(p => `
                      <div class="mb-1 text-gray-200">${p.name}<br><small class="text-yellow-400">Kills - ${p.kills}<br>Damage - ${p.damage}</small></div>
                    `).join('')}
                  </div>
                </td>
                <td class="text-yellow-200">${team.totalKills}</td>
                <td class="text-yellow-200">${team.totalDamage}</td>
                <td class="font-bold text-yellow-400">${team.score.toFixed(1)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function exportPNG() {{
      html2canvas(document.getElementById("scoreboard")).then(canvas => {{
        const link = document.createElement("a");
        link.download = "scoreboard.png";
        link.href = canvas.toDataURL();
        link.click();
      }});
    }}
  </script>
</body>
</html>
