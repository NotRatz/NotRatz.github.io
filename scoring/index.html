<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strive Scoring Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body {{
      background-color: #0f0f0f;
      color: #e5e5e5;
    }}
    .score-table th, .score-table td {{
      border: 1px solid #333;
      padding: 0.5rem;
    }}
    .team-box {{
      background-color: #1a1a1a;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
    }}
  </style>
</head>
<body class="p-6">
  <h1 class="text-3xl font-bold mb-4">Strive Naraka Scoring Tool</h1>

  <div class="mb-6">
    <label class="block mb-2">Kill Multiplier:</label>
    <input type="number" id="killMultiplier" class="text-black p-2 rounded" value="1">
    <label class="block mt-4 mb-2">Placement Points (Rank 1 to 12):</label>
    <div id="placementInputs" class="grid grid-cols-3 gap-2">
      <!-- JS will inject 12 inputs here -->
    </div>
  </div>

  <div class="mb-6">
    <label class="block mb-2">Upload up to 6 CSV files (each one match):</label>
    <input type="file" id="csvFiles" accept=".csv" multiple class="mb-4">
    <button onclick="processFiles()" class="bg-blue-600 text-white px-4 py-2 rounded">Generate Scoreboard</button>
    <button onclick="exportPNG()" class="bg-green-600 text-white px-4 py-2 rounded ml-2">Export as PNG</button>
  </div>

  <div id="scoreboard" class="overflow-x-auto mt-6"></div>

  <script>
    for (let i = 1; i <= 12; i++) {{
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'text-black p-2 rounded';
      input.value = 13 - i; // Default: 1st = 12 pts, 2nd = 11, etc.
      input.id = 'rank-' + i;
      document.getElementById('placementInputs').appendChild(input);
    }}

    function processFiles() {{
      const files = document.getElementById('csvFiles').files;
      if (!files.length) return;

      let allData = [];
      let filesProcessed = 0;

      for (let file of files) {{
        Papa.parse(file, {{
          header: true,
          complete: function(results) {{
            allData.push(results.data);
            filesProcessed++;
            if (filesProcessed === files.length) {{
              calculateScores(allData.flat());
            }}
          }}
        }});
      }}
    }}

    function calculateScores(data) {{
      const killMultiplier = parseFloat(document.getElementById('killMultiplier').value);
      const placementPoints = Array.from({{ length: 12 }}, (_, i) =>
        parseFloat(document.getElementById('rank-' + (i + 1)).value)
      );

      const teams = {{}};

      data.forEach(row => {{
        const teamID = row.TeamID;
        const playerName = row.PlayerName;
        const rank = parseInt(row.Rank);
        const kills = parseInt(row.KillCount);
        const damage = parseInt(row.TotalHurt);

        if (!teams[teamID]) {{
          teams[teamID] = {{
            teamID,
            players: [],
            totalKills: 0,
            totalDamage: 0,
            score: 0,
            rank: rank
          }};
        }}

        teams[teamID].players.push({{ name: playerName, kills, damage }});
        teams[teamID].totalKills += kills;
        teams[teamID].totalDamage += damage;
        teams[teamID].score += kills * killMultiplier;
        if (placementPoints[rank - 1]) {{
          teams[teamID].score += placementPoints[rank - 1] / 3; // split evenly (3p teams)
        }}
      }});

      const sortedTeams = Object.values(teams).sort((a, b) => b.score - a.score);

      const container = document.getElementById('scoreboard');
      container.innerHTML = `
        <table class="score-table w-full text-left">
          <thead>
            <tr class="bg-gray-700">
              <th>Rank</th>
              <th>Players</th>
              <th>Total Kills</th>
              <th>Total Damage</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody>
            ${sortedTeams.map((team, i) => `
              <tr class="bg-gray-800">
                <td>${i + 1}</td>
                <td>
                  <div class="team-box">
                    ${team.players.map(p => `
                      <div class="mb-1">${p.name}<br><small>Kills - ${p.kills}<br>Damage - ${p.damage}</small></div>
                    `).join('')}
                  </div>
                </td>
                <td>${team.totalKills}</td>
                <td>${team.totalDamage}</td>
                <td>${team.score.toFixed(1)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }}

    function exportPNG() {{
      html2canvas(document.getElementById("scoreboard")).then(canvas => {{
        const link = document.createElement("a");
        link.download = "scoreboard.png";
        link.href = canvas.toDataURL();
        link.click();
      }});
    }}
  </script>
</body>
</html>
